SuexecUserGroup #1026 #1026
ServerName gear.tsp.edu.rs
ServerAlias www.gear.tsp.edu.rs
ServerAlias mail.gear.tsp.edu.rs
ServerAlias webmail.gear.tsp.edu.rs
ServerAlias admin.gear.tsp.edu.rs

# CHANGED: Point to the React build output
DocumentRoot /home/gear/public_html/dist

ErrorLog /var/log/virtualmin/gear.tsp.edu.rs_error_log
CustomLog /var/log/virtualmin/gear.tsp.edu.rs_access_log combined
ScriptAlias /cgi-bin/ /home/gear/cgi-bin/
ScriptAlias /awstats /home/gear/cgi-bin/awstats.pl
DirectoryIndex index.html index.php index.htm

# CHANGED: Directory options for React App
<Directory /home/gear/public_html/dist>
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    
    # React Router Rewrites
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
</Directory>

<Directory /home/gear/cgi-bin>
    Require all granted
    AllowOverride All Options=ExecCGI,Includes,IncludesNOEXEC,Indexes,MultiViews,SymLinksIfOwnerMatch
</Directory>

ProxyPass /.well-known !
RewriteEngine on
RewriteCond %{HTTP_HOST} =webmail.gear.tsp.edu.rs
RewriteRule ^/(?!.well-known)(.*)$ https://gear.tsp.edu.rs:20000/ [R]
RewriteCond %{HTTP_HOST} =admin.gear.tsp.edu.rs
RewriteRule ^/(?!.well-known)(.*)$ https://gear.tsp.edu.rs:10000/ [R]

RemoveHandler .php
RedirectMatch ^/awstats$ /awstats/

# Proxy API requests to Node.js
ProxyPass /api http://localhost:3001/api
ProxyPassReverse /api http://localhost:3001/api

# Proxy Webhook requests
ProxyPass /webhook http://localhost:9000
ProxyPassReverse /webhook http://localhost:9000

# Proxy Socket.io (WebSocket + Polling)
RewriteEngine On
RewriteCond %{REQUEST_URI}  ^/socket.io            [NC]
RewriteCond %{QUERY_STRING} transport=websocket    [NC]
RewriteRule /(.*)           ws://localhost:3001/socket.io/$1 [P,L]

ProxyPass        /socket.io http://localhost:3001/socket.io
ProxyPassReverse /socket.io http://localhost:3001/socket.io

<FilesMatch \.php$>
    SetHandler None
    AddType text/plain .php
</FilesMatch>

<Files awstats.pl>
    AuthName "gear.tsp.edu.rs statistics"
    AuthType Basic
    AuthUserFile /home/gear/.awstats-htpasswd
    require valid-user
</Files>
